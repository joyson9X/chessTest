<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Tournament Registration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #15803d; /* Rich green background */
            overflow-x: hidden;
        }
        #fluid-background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.3;
        }
        .content-wrapper {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-white">

    <!-- Animated Canvas Background -->
    <canvas id="fluid-background-canvas"></canvas>

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-2xl content-wrapper">

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-white tracking-tight">Chess Tournament</h1>
            <p class="text-lime-200 mt-2">Hosted by Nalla'sFanClub</p>
            <p class="text-gray-200 mt-4">Register below to join the tournament.</p>
        </div>

        <!-- Registration & Thank You Container -->
        <div id="form-container" class="bg-black/40 backdrop-blur-sm p-6 md:p-8 rounded-2xl shadow-2xl border border-white/20 w-full transition-all duration-300">
            
            <!-- Registration View -->
            <div id="registration-view">
                <h2 class="text-3xl font-bold mb-6 text-center text-white">Registration Form</h2>
                <form id="registration-form" class="space-y-4">
                    <div>
                        <label for="name" class="block mb-2 text-sm font-medium text-gray-200">Full Name</label>
                        <input type="text" id="name" class="transition-colors duration-300 bg-black/30 border border-gray-700 text-white text-sm rounded-lg focus:ring-lime-400 focus:border-lime-400 block w-full p-2.5" placeholder="e.g., Magnus Carlsen" required>
                    </div>
                    <div>
                        <label for="age" class="block mb-2 text-sm font-medium text-gray-200">Age</label>
                        <input type="number" id="age" class="transition-colors duration-300 bg-black/30 border border-gray-700 text-white text-sm rounded-lg focus:ring-lime-400 focus:border-lime-400 block w-full p-2.5" placeholder="e.g., 33" required>
                    </div>
                    <div id="error-message" class="text-red-400 text-sm pt-1 text-center h-5 font-semibold"></div>
                    <button id="submit-button" type="submit" class="w-full text-gray-900 bg-lime-300 hover:bg-lime-400 focus:ring-4 focus:outline-none focus:ring-lime-500 font-bold rounded-lg text-sm px-5 py-3 text-center transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        Register
                    </button>
                </form>
            </div>
            
            <!-- Thank You View (Initially Hidden) -->
            <div id="thank-you-view" class="hidden text-center">
                <h2 class="text-3xl font-bold text-lime-300">Thank You!</h2>
                <p class="text-white my-6">Your registration is complete.</p>
                <button id="register-another-btn" class="w-full text-gray-900 bg-lime-300 hover:bg-lime-400 focus:ring-4 focus:outline-none focus:ring-lime-500 font-bold rounded-lg text-sm px-5 py-3 text-center transition-colors duration-300">
                    Register Another Person
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Fluid Background Animation ---
        const canvas = document.getElementById('fluid-background-canvas');
        const ctx = canvas.getContext('2d');
        let time = 0;
        const gridSize = 80;
        const distortion = 15;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function drawFluidGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const cols = Math.ceil(canvas.width / gridSize) + 1;
            const rows = Math.ceil(canvas.height / gridSize) + 1;

            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const offX = Math.sin(time + x * 0.3 + y * 0.2) * distortion;
                    const offY = Math.cos(time + x * 0.2 + y * 0.3) * distortion;
                    ctx.fillStyle = (x + y) % 2 === 0 ? '#1e3a8a' : '#15803d';
                    ctx.fillRect(x * gridSize + offX, y * gridSize + offY, gridSize, gridSize);
                }
            }
        }

        function animate() {
            time += 0.01;
            drawFluidGrid();
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', resizeCanvas);
        // Start animation on window load
        window.onload = () => {
            resizeCanvas();
            animate();
        };


        // --- 1. Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDyim0iURkyznO0K8oqFSz-owNi0uk-S74",
            authDomain: "chess-67b7f.firebaseapp.com",
            projectId: "chess-67b7f",
            storageBucket: "chess-67b7f.appspot.com",
            messagingSenderId: "218765179675",
            appId: "1:218765179675:web:8f0f3e7d8c7e15d5c2b1be",
            measurementId: "G-7JCQNHEWCZ"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. DOM Element References ---
        const registrationView = document.getElementById('registration-view');
        const thankYouView = document.getElementById('thank-you-view');
        const registrationForm = document.getElementById('registration-form');
        const errorMessageDiv = document.getElementById('error-message');
        const registerAnotherBtn = document.getElementById('register-another-btn');
        const submitButton = document.getElementById('submit-button');
        const formContainer = document.getElementById('form-container');

        // --- 3. Firestore Collection Reference ---
        const registrationsCollectionRef = collection(db, 'registrations');
        
        // --- 4. Page Switching Logic ---
        function showView(viewId) {
            if (viewId === 'registration-view') {
                registrationView.classList.remove('hidden');
                thankYouView.classList.add('hidden');
            } else if (viewId === 'thank-you-view') {
                registrationView.classList.add('hidden');
                thankYouView.classList.remove('hidden');
            }
        }

        // --- 5. Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Authenticated anonymously. User ID:", user.uid);
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Authentication Error:", error);
                    errorMessageDiv.textContent = "Error connecting to service.";
                }
            }
        });

        // --- 6. Form Submission Logic ---
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Reset visual state from previous errors
            errorMessageDiv.textContent = '';
            formContainer.classList.remove('border-red-500');
            formContainer.classList.add('border-white/20');

            // Disable button and show loading state
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            const name = document.getElementById('name').value.trim();
            const age = document.getElementById('age').value;

            if (!name || !age) {
                errorMessageDiv.textContent = 'Please fill out all fields.';
                submitButton.disabled = false;
                submitButton.textContent = 'Register';
                return;
            }

            try {
                // Save data to Firestore
                await addDoc(registrationsCollectionRef, {
                    name: name,
                    age: Number(age),
                    registeredAt: new Date()
                });
                
                // Reset the form and show the thank you page
                registrationForm.reset();
                showView('thank-you-view');
                
            } catch (error) {
                console.error("Error adding document: ", error);
                errorMessageDiv.textContent = 'Registration failed. Check permissions.';
                formContainer.classList.add('border-red-500'); // Make error visible
                formContainer.classList.remove('border-white/20');
            } finally {
                // Re-enable the button regardless of success or failure
                submitButton.disabled = false;
                submitButton.textContent = 'Register';
            }
        });

        // --- 7. "Register Another" Button ---
        registerAnotherBtn.addEventListener('click', () => {
            showView('registration-view');
        });

    </script>
</body>
</html>
